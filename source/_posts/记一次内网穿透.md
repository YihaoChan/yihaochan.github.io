---
title: 记一次内网穿透
date: 2021-03-21 05:26:28
categories: Web
tags: FRP
---

# 0 背景

最近和同学在做大数据比赛，需要用到GPU服务器加速模型训练。而自己在家里，没有服务器资源可用。另一位同学在学校，他们的实验室有服务器，且可以(偷偷)拿来跑比赛要用的模型，但是只能用校园网才能连上。而我又需要经常用到服务器，总是发给他们跑也怪麻烦的，所以想到了一个办法——内网穿透。通过内网穿透，就可以实现从我自己(校外)的机器访问到校园内的实验室机器。此处特别感谢两位技术宅同学想到了这个办法！

一开始，A同学先用他自己已经租了的阿里云服务器配置好了一遍内网穿透。而我这几天也租(免费试用)了一个来玩玩，所以也想尝试下自己搭一下内网穿透。

# 1 环境配置

## 1.1 公网VPS

实现内网穿透需要有一台固定IP的公网VPS，可用它作为跳板访问内网端口，而这台具有固定IP的公网VPS就是我目前已经在阿里云上配置好的公网服务器。

在阿里云官网上查询到我租的公网服务器的**公网IP**为47.106.232.139：

![](/images/记一次内网穿透/公网IP.png)

## 1.2 FRP

实现内网穿透的方式有多种，我们用的是FRP来实现。FRP(Fast Reverse Proxy)就是一个反向代理软件，它体积轻量但功能很强大，可以**使处于内网或防火墙后的设备对外界提供服务**，它支持HTTP、TCP、UDP等众多协议。我们今天仅讨论TCP和UDP相关的内容。

FRP结构很简单，分为frps和frpc两个可执行程序。**在公网服务器上运行frps，在内网机器上运行frpc**即可。

## 1.3 端口

约定用于**frps和frpc进程运行时占用的端口**号为7007，用于**访问内网机器时内网机器开放的端口**号为7777。这两个端口都要在阿里云的安全组上面开放。

在阿里云上添加安全组，开放两个端口：

1. 一个用于frps和frpc运行时占用的端口(下图中为7007)；
2. 一个用于从外面的网络访问实验室机器时，内网机器所开放的端口(下图中为7777)。

![](/images/记一次内网穿透/阿里云端口.png)

# 2 免密连接服务器

由于每次ssh连接服务器时都需要输入密码，因此，如果能够保证安全又想节省时间的情况的话，通过以下操作可去掉每次都要输入密码的时间，实现免密连接。

在**本地机器**创建密钥，一路回车：

```
 ssh-keygen -t rsa -b 4096
```

把密钥从本地上传到服务器：

```
cd ~/.ssh
scp id_rsa.pub root@47.106.232.139:~/tmp.pub
```

登录**服务器**：

```
ssh root@47.106.232.139
```

创建文件夹并写入信任名单：

```
mkdir ~/.ssh
cat ~/tmp.pub >> ~/.ssh/authorized_keys
rm ~/tmp.pub
```

**退出服务器**，再ssh连接，发现不需要密码了，成功。

# 3 FRP服务器端

ssh连接阿里云服务器：

```
ssh root@47.106.232.139
```

在公网服务器端下载FRP并解压，此处下载0.36.1版本：

```
wget https://github.com/fatedier/frp/releases/download/v0.36.1/frp_0.36.1_linux_amd64.tar.gz

tar -zxvf frp_0.36.1_linux_amd64.tar.gz
```

吐槽一句，私以为阿里云这种级别会自己帮我们把各种网络啥的配置好，然后访问github就会快一点，没想到还是龟速，后来才得知租一台服务器其实也相当于拿到了一台什么都没有的机器。所以，如果wget下载github上的文件实在太慢的话，就找一下Github下载链接的镜像版本，这样就快很多。

因为**公网服务器充当frp服务器端**，所以只留下以下两个文件即可：

```
frps  frps.ini
```

修改frps.ini配置文件：

```
vim ./frps.ini
```

![](/images/记一次内网穿透/公网frps.png)

其中，bind_port就是先前在阿里云上开放的用于frp运行时占用的端口，此处设置为7007。

# 4 FRP客户端

由于人没在学校用不了校园网，而同学之前已经做过一个端口的内网穿透，所以先借助这个跳板连上实验室机器。其中，7788是他们已经成功内网穿透的一个端口，公网服务器IP是已经成功内网穿透的公网服务器IP。所以，先ssh连上内网机器：

```
ssh -p 7788 实验室机器用户名@公网服务器IP
```

同样，在内网端下载FRP并解压，此处下载0.36.1版本：

```
wget https://github.com/fatedier/frp/releases/download/v0.36.1/frp_0.36.1_linux_amd64.tar.gz

tar -zxvf frp_0.36.1_linux_amd64.tar.gz
```

因为**内网机器充当frp客户端**，所以只留下以下两个文件即可：

```
frpc   frpc.ini
```

修改frpc.ini配置文件：

```
vim ./frpc.ini
```

![](/images/记一次内网穿透/内网frpc.png)

其中：

1. server_addr为**阿里云公网服务器IP**；
2. server_port为先前在阿里云上开放的用于frp运行时占用的端口，即需要和frps.ini中的bind_port对齐，此处设置为7007；
3. remote_port为先前在阿里云上开放的用于访问内网机器的端口，此处设置为7777。

# 5 后台运行FRP

## 5.1 公网服务器端

首先，在**公网服务器端后台运行frps**。目录定位到当前frp文件夹，在命令行中输入：

```
nohup ./frps -c ./frps.ini >/dev/null 2>&1 &
```

输入```jobs```命令，若看到进程状态是Running，即frps进程运行成功。

## 5.2 内网机器端

其次，在**内网机器端后台运行frpc**。目录定位到当前frp文件夹，在命令行中输入：

```
nohup ./frpc -c ./frpc.ini >/dev/null 2>&1 &
```

输入```jobs```命令，若看到进程状态是Running，即frpc进程运行成功。

# 6 访问内网

最后一步，通过外网机器访问内网机器。在**本地**命令行窗口输入：

```
ssh -p 7777 实验室机器用户名@47.106.232.139
```

不出意外的话，输入密码就连接成功啦。

# 7 过程中遇到的问题

## 7.1 防火墙

在公网服务器端运行frps，报no route to host的错误。这种错误是由于公网服务器端的防火墙没有关闭引起的。因此，在公网服务器端输入以下命令：

查看防火墙状态

```
firewall-cmd --state
```

停止防火墙

```
systemctl stop firewalld.service
```

禁止firewall开机启动

```
systemctl disable firewalld.service 
```

问题解决。

## 7.2 端口占用

由于一开始不太懂得怎么操作，所以有时候会把某一个端口开了之后，又在相同的端口上运行了其他进程，故会报Error starting userland proxy: listen tcp 0.0.0.0:xxxx: bind: address already in use的错误。这种情况下，需要先查看当前机器的端口占用情况，然后把端口进程杀死即可。

查看端口占用情况：

```
netstat -tanlp
```

查看到需要停止的端口进程PID后，输入：

```
kill PID
```

即可将该端口处的进程停止。

# 参考链接

[阿里云服务器实现frp内网穿透](https://blog.csdn.net/cao0507/article/details/82758288)

[frp实现内网穿透](https://zhuanlan.zhihu.com/p/45445979)

[在外如何访问内网？—— FRP内网穿透](https://zhuanlan.zhihu.com/p/347239470?utm_source=wechat_session&utm_medium=social&utm_oi=939179790134165504)